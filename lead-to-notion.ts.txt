// /api/lead-to-notion.ts — Studio Nara → Notion API Proxy
import type { VercelRequest, VercelResponse } from '@vercel/node';

// Variables d'environnement (configurées dans Vercel)
const NOTION_TOKEN = process.env.NOTION_TOKEN!;
const DATABASE_ID = process.env.NOTION_DATABASE_ID!;

// Petit test GET pour vérifier que l’API répond
export default async function handler(req: VercelRequest, res: VercelResponse) {
  if (req.method === 'GET') {
    return res.status(200).json({ ok: true, message: 'API up' });
  }

  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  try {
    const body = req.body;

    // Vérification des champs obligatoires
    if (!body?.nom || !body?.email) {
      return res.status(400).json({ error: 'Nom et Email requis' });
    }

    // Map des besoins (checkbox → multi-select Notion)
    const besoinsLabels = Object.entries(body.besoins || {})
      .filter(([, v]) => Boolean(v))
      .map(([k]) => {
        switch (k) {
          case 'site': return 'Création de site';
          case 'refonte': return 'Refonte';
          case 'seo': return 'SEO';
          case 'contenu': return 'Contenu mensuel';
          case 'branding': return 'Identité visuelle';
          case 'autre': return 'Autre';
          default: return k;
        }
      });

    // Création de la page dans Notion
    const response = await fetch('https://api.notion.com/v1/pages', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${NOTION_TOKEN}`,
        'Content-Type': 'application/json',
        'Notion-Version': '2022-06-28',
      },
      body: JSON.stringify({
        parent: { database_id: DATABASE_ID },
        properties: {
          Name: { title: [{ text: { content: body.nom } }] },
          Email: body.email ? { email: body.email } : undefined,
          Téléphone: body.tel ? { phone_number: body.tel } : undefined,
          Société: body.societe ? { rich_text: [{ text: { content: body.societe } }] } : undefined,
          Budget: body.budget && body.budget !== '—' ? { select: { name: body.budget } } : undefined,
          Délai: body.delai && body.delai !== '—' ? { select: { name: body.delai } } : undefined,
          Besoins: besoinsLabels.length ? { multi_select: besoinsLabels.map((n) => ({ name: n })) } : undefined,
          Message: body.message ? { rich_text: [{ text: { content: body.message } }] } : undefined,
          'UTM Source': body.utm_source ? { rich_text: [{ text: { content: body.utm_source } }] } : undefined,
          'UTM Medium': body.utm_medium ? { rich_text: [{ text: { content: body.utm_medium } }] } : undefined,
          'UTM Campaign': body.utm_campaign ? { rich_text: [{ text: { content: body.utm_campaign } }] } : undefined,
          'Page URL': body.page_url ? { url: body.page_url } : undefined,
          Referrer: body.referrer ? { url: body.referrer } : undefined,
          Statut: { select: { name: 'Nouveau' } },
        },
      }),
    });

    if (!response.ok) {
      const errorText = await response.text();
      return res.status(500).json({ error: 'Notion API error', details: errorText });
    }

    const data = await response.json();
    return res.status(200).json({ ok: true, notionId: data.id });
  } catch (err: any) {
    return res.status(500).json({ error: err?.message || 'Erreur serveur' });
  }
}
